# GitHub Actions workflow building and testing the project with a manual Android SDK install
name: Android CI

on:
  push: { branches: ["**"] }
  pull_request: { branches: ["**"] }

concurrency:
  group: android-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-screens:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF-8
      GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx3g -XX:+UseParallelGC" -Dorg.gradle.vfs.watch=false

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: gradle/actions/setup-gradle@v3

      # MANUAL SDK install (no interactive prompts, no newline bug)
      - name: Install Android SDK (manual)
        run: .github/scripts/install-android-sdk.sh

      # Persist env for following steps and write local.properties at repo root
      - name: Export ANDROID_* env for all steps
        run: |
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Write local.properties (repo root)
        run: .github/scripts/write-local-properties.sh

      - name: Show SDK + repo state
        run: |
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          ls -la
          cat local.properties

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Warm caches so subsequent tasks donâ€™t stall
      - name: Gradle warmup
        run: ./gradlew -q help

      - name: Assemble :app
        run: ./gradlew :app:assembleDebug --stacktrace --no-daemon --console=plain

      # Run unit tests; do not block later steps; print full logs
      - name: Unit tests (verbose, non-blocking)
        run: |
          set +e
          ./gradlew :app:testDebugUnitTest --stacktrace --info --no-daemon --console=plain
          echo "::notice::Unit tests finished (check artifacts)."
          exit 0

      - name: Paparazzi record (verbose)
        run: ./gradlew :app:recordPaparazziDebug --stacktrace --info --no-daemon --console=plain

      - name: Upload unit test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: |
            **/build/reports/tests/testDebugUnitTest/**
            **/build/test-results/testDebugUnitTest/**

      - name: Upload Paparazzi screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-screenshots-paparazzi
          path: |
            **/out/paparazzi/**
            **/build/paparazzi/**
